# Домашнее задание №4 (Chaos Engineering) MtsCloud "Проект для студента poshta69" K8s namespase "sre-cource-student-72"
*Задача:*

1. Отключение узла: Планово остановить один из узлов кластера, чтобы проверить процедуру переключения ролей (failover). - Анализировать время, необходимое для восстановления и как система выбирает новый Master узел (и есть ли вообще там стратегия выбора?).
2. Имитация частичной потери сети: Использовать инструменты для имитации потери пакетов или разрыва TCP-соединений между узлами. Цель — проверить, насколько хорошо система справляется с временной недоступностью узлов и как быстро восстанавливается репликация.
3. Высокая нагрузка на CPU или I/O: Запустить процессы, которые создают высокую нагрузку на CPU или дисковую подсистему одного из узлов кластера, чтобы проверить, как это влияет на производительность кластера в целом и на работу Patroni.
4. Тестирование систем мониторинга и оповещения: С помощью chaos engineering можно также проверить, насколько эффективны системы мониторинга и оповещения. Например, можно искусственно вызвать отказ, который должен быть зарегистрирован системой мониторинга, и убедиться, что оповещения доставляются вовремя.

*Если сделали все предыдущие:*

1. "Split-brain": Одновременно изолировать несколько узлов от сети и дать им возможность объявить себя новыми мастер-узлами. Проверить, успеет ли Patroni достичь
консенсуса и избежать ситуации "split-brain".
2. Долгосрочная изоляция: Оставить узел изолированным от кластера на длительное время, затем восстановить соединение и наблюдать за процессом синхронизации и
восстановления реплики.
3. Сбои сервисов зависимостей: Изучить поведение кластера Patroni при сбоях в сопутствующих сервисах, например, etcd (которые используются для хранения состояния кластера), путем имитации его недоступности или некорректной работы.

*Схема системы*

![ht](/ht/img/cluster.png)

## Инструменты
Для выполнения тестирования будем использовать следующие инструменты:
    - [Artillery](https://www.artillery.io/docs/get-started/get-artillery)
    - [ChaosBlade](https://chaosblade.io/en/)
    - Консоль MtsCloud
    - ChatGPT v4

## Задача №1.
Иcходя из условий задачи, нашей цулью является кластер Postgres под управлением patroni.
### Описание эксперимента
Отработаем два варианта отключения:
    1. Ведомый хост
    2. Ведущий хост
Ход выполнения:
    1. Создадим нагрузку на приложение в 1-2 rps/s используя Artillery
    2. Планово остановим один из узлов кластера используя один из способов
    ```Bash
    shutdown -P now
    services postgresql stop
    ```
    или выключить хост через консоль MtsCloud
### Ожидаемые результаты
При потере ведомомо узла - оповещения от системы мониторинга и при наличии разделения чтение/запись просадку в rps/s, если не настроено, то влияния на приложение не окажет. Приложение не настроено на разделение чтение/запись, значит должны получить только оповещения, на работу не должно быть оказано влияние.

При потере ведущего узла - оповещения от системы мониторинга, смена лидера и недоступность ресурса не более 30 секунд (patroni ttl=30), после восстановления работы отключенной ноды она должна стать ведомой и начать репликацию.
### Реальные результаты
### Анализ результатов
